---
description: 智能扫描专利章节文档，分析并补充缺失的附图（仅处理章节03-07）
arguments:
  - name: directory
    description: 专利章节文件所在目录（默认当前目录）
    required: false
  - name: force_regenerate
    description: 是否强制重新生成所有附图（默认false，仅补充缺失）
    required: false
  - name: skip_confirmation
    description: 跳过用户确认，直接执行（默认false）
    required: false
---

# 专利附图智能更新命令

你正在调用专利附图智能更新功能。本命令将扫描现有专利章节文档，智能判断并补充缺失的附图。

## 功能概述

本命令专注于**附图补充**，不修改章节正文内容，仅：

1. 扫描章节 03-07（背景技术、技术问题、技术方案、有益效果、具体实施方式）
2. 智能分析每个章节是否需要附图
3. 检测现有附图编号，确保连续性
4. 调用专门的附图生成器生成缺失的附图
5. 将附图嵌入到章节文件中

**不处理**：
- 不生成章节正文内容
- 不修改现有附图
- 不整合完整交底书

## 工作流程

### 步骤 1：扫描章节文件

使用 Glob 工具扫描目录中的章节文件：

```
Glob: [0-9][0-9]_*.md
```

筛选出需要处理的章节（03-07）：
- 03_背景技术.md
- 04_技术问题.md
- 05_技术方案.md
- 06_有益效果.md
- 07_具体实施方式.md

**验证**：
- 检查文件是否存在
- 记录缺失的章节文件
- 提示用户缺失情况

### 步骤 2：分析章节内容，判断需要哪些附图

对每个存在的章节文件：

**2.1 读取文件内容**
使用 Read 工具读取章节全文

**2.2 关键词匹配**
使用以下规则判断是否需要附图：

| 章节文件 | 需要检测的附图类型 | 触发关键词 |
|---------|------------------|-----------|
| 03_背景技术.md | 现有技术架构图（可选） | "现有技术"、"传统方案"、"架构"、"系统" |
| 04_技术问题.md | 问题场景图（可选） | "问题"、"缺陷"、"场景"、"困境" |
| 05_技术方案.md | **架构图、协议图、原理图（核心）** | "架构"、"协议"、"格式"、"原理"、"机制" |
| 06_有益效果.md | 效果对比图（可选） | "对比"、"提升"、"性能" |
| 07_具体实施方式.md | **流程图、时序图（核心）** | "流程"、"步骤"、"时序"、"交互"、"消息" |

**2.3 构建附图需求清单**
对每个章节，记录需要生成的附图类型和数量

### 步骤 3：统计现有附图编号

**3.1 扫描现有附图**
使用正则表达式扫描所有章节文件：

```
#### 附图(\d+)：
```

**3.2 验证编号连续性**
- 检查编号是否从1开始连续
- 检测是否有跳号
- 确定下一个可用编号

**3.3 处理不连续情况**
如果发现跳号：
```
⚠️ 警告：检测到附图编号不连续
现有附图：图1, 图2, 图3, 图5
缺失编号：图4

选项：
[1] 从最大编号继续（图6开始）
[2] 重新生成所有附图
[3] 取消操作
```

### 步骤 4：用户确认

**4.1 生成检测报告**
向用户展示：

```markdown
=== 附图需求检测报告 ===

扫描的章节：
✓ 03_背景技术.md - 需要1幅图（现有技术架构图）
✓ 05_技术方案.md - 需要2幅图（系统架构图、协议格式图）
✓ 07_具体实施方式.md - 需要3幅图（流程图×2、时序图×1）
✗ 04_技术问题.md - 不需要附图
✗ 06_有益效果.md - 不需要附图

现有附图：
- 图1, 图2, 图3

附图编号状态：
✓ 连续
下一个可用编号：4

需要生成的附图：
1. 图4 - 现有技术架构图（03_背景技术.md）
2. 图5 - 系统架构图（05_技术方案.md）
3. 图6 - 协议格式图（05_技术方案.md）
4. 图7 - 设备初始化流程图（07_具体实施方式.md）
5. 图8 - 设备发现时序图（07_具体实施方式.md）
6. 图9 - IP分配流程图（07_具体实施方式.md）

是否继续？
[继续] [跳过特定章节] [取消]
```

**4.2 处理用户选择**
- **继续**：执行所有附图生成
- **跳过特定章节**：让用户选择要跳过的章节
- **取消**：终止操作

### 步骤 5：调用附图生成器

**5.1 附图类型-生成器映射**

| 附图类型 | 调用子代理 |
|---------|-----------|
| 流程图 | flowchart-generator |
| 时序图 | sequence-generator |
| 协议格式图 | protocol-generator |
| 架构图/结构图/原理图/场景图 | architecture-generator |

**5.2 参数传递格式**

对每幅附图，调用对应生成器：

```
## 调用流程图生成器

Task(tool="flowchart-generator",
     prompt="附图编号：{figure_number}，
           流程描述：{从章节中提取的流程描述}，
           附图标记起始值：{figure_number * 100}")

## 调用时序图生成器

Task(tool="sequence-generator",
     prompt="附图编号：{figure_number}，
           时序描述：{从章节中提取的时序描述}，
           参与者列表：{提取的参与者列表}，
           附图标记起始值：{figure_number * 100}")

## 调用协议格式图生成器

Task(tool="protocol-generator",
     prompt="附图编号：{figure_number}，
           协议格式描述：{从章节中提取的协议格式描述}，
           字段列表：{从章节中提取的字段定义}，
           附图标记起始值：{figure_number * 100}")

## 调用架构图生成器

Task(tool="architecture-generator",
     prompt="附图编号：{figure_number}，
           附图描述：{从章节中提取的架构描述}，
           图表类型：{system-architecture/software-architecture/module-structure/principle/application-scenario}，
           附图标记起始值：{figure_number * 100}")
```

**5.3 维护附图编号**

使用全局计数器确保编号连续：

```
初始化：current_figure_number = next_available_number

对每个附图生成：
1. 传入 current_figure_number 作为附图编号
2. 获取返回的 Mermaid 代码
3. 更新：current_figure_number += 1
```

### 步骤 6：插入附图到章节文件

**6.1 确定插入位置**

根据附图类型，在章节中找到最佳插入位置：

| 附图类型 | 插入位置 |
|---------|---------|
| 现有技术架构图 | 背景技术描述段落前 |
| 问题场景图 | 问题描述段落前 |
| 系统架构图 | 技术方案第一个段落前 |
| 协议格式图 | 协议描述段落前 |
| 流程图 | 对应流程描述段落前 |
| 时序图 | 交互描述段落前 |

**6.2 嵌入格式**

在目标位置插入以下格式：

```markdown
#### 附图X：[附图名称]

```mermaid
[Mermaid代码]
```

图X说明：[附图说明文字]
```

**6.3 更新文件**

使用 Write 工具保存修改后的章节文件

### 步骤 7：生成最终报告

**7.1 统计信息**
- 扫描的章节数量
- 需要更新的章节数量
- 生成的附图数量
- 修改的文件列表

**7.2 附图清单**
列出所有生成的附图：

| 图编号 | 附图名称 | 附图类型 | 目标章节 |
|--------|---------|---------|---------|
| 图4 | 现有技术架构示意图 | 架构图 | 03_背景技术.md |
| 图5 | 系统整体架构图 | 架构图 | 05_技术方案.md |
| ... | ... | ... | ... |

**7.3 验证结果**
- 附图编号连续性验证
- 文件修改确认

**7.4 后续建议**
提示用户可能的后续操作：
- 查看生成的附图
- 手动调整（如需要）
- 运行 `/patent` 整合完整交底书

## 智能判断逻辑

### 章节内容分析规则

**03_背景技术.md**：
- 如果描述现有系统架构 → 需要生成"现有技术架构图"
- 关键词："现有技术"、"传统方案"、"背景技术"、"架构"、"系统"
- 触发条件：关键词出现 >= 2次 或 段落长度 > 200字

**04_技术问题.md**：
- 如果问题涉及复杂场景 → 需要生成"问题场景图"
- 关键词："问题"、"缺陷"、"不足"、"场景"、"困境"
- 触发条件：关键词出现 >= 2次

**05_技术方案.md**（核心章节）：
- 描述系统架构 → 生成"系统架构图"
- 关键词："架构"、"系统"、"整体"
- 描述协议格式 → 生成"协议格式图"
- 关键词："协议"、"格式"、"消息结构"、"字段"
- 描述技术原理 → 生成"原理图"
- 关键词："原理"、"机制"、"检测机制"
- 触发条件：对应类型关键词出现 >= 1次

**06_有益效果.md**：
- 如果需要对比效果 → 生成"效果对比图"
- 关键词："对比"、"提升"、"改善"、"效果"、"性能"
- 触发条件：关键词出现 >= 2次 且 包含具体数据

**07_具体实施方式.md**（核心章节）：
- 描述操作流程 → 生成"流程图"
- 关键词："流程"、"步骤"、"首先"、"然后"、"最后"、"初始化"
- 描述消息交互 → 生成"时序图"
- 关键词："时序"、"交互"、"消息"、"发送"、"请求"
- 触发条件：对应类型关键词出现 >= 2次

## 附图编号管理

### 编号连续性保证

**初始化**：
```
1. 扫描所有章节文件，提取现有附图编号
2. 排序并去重：existing_figures = sorted(set(all_figures))
3. 确定下一个编号：next_figure = max(existing_figures) + 1（如果存在）或 1（如果不存在）
```

**生成过程**：
```
对每个附图需求：
1. 使用 next_figure 作为当前附图编号
2. 调用生成器：generator(figure_number=next_figure)
3. 生成后递增：next_figure += 1
```

**验证**：
```
生成完成后：
1. 重新扫描所有附图编号
2. 检查是否连续：是否从1开始，无跳号
3. 如发现不连续，报告警告
```

### 跳号处理

如果用户选择"强制重新生成"：
```
1. 提示用户将覆盖所有现有附图
2. 删除所有现有附图块
3. 从编号1开始重新生成
```

如果发现跳号但用户选择"继续"：
```
1. 从最大编号继续生成
2. 在报告中标注跳号情况
3. 建议用户手动重新编号或选择重新生成
```

## 错误处理

### 章节文件不存在

```markdown
❌ 错误：章节文件缺失

📄 缺失文件：
  - 03_背景技术.md
  - 05_技术方案.md

💡 建议：
  1. 确认是否在其他目录
  2. 使用 --directory 参数指定正确目录
  3. 运行 /patent 命令先生成完整章节
```

### 生成器调用失败

```markdown
❌ 错误：附图生成失败

📄 附图：图5 系统架构图
🔍 原因：generator returned error

💡 处理：
  - 自动重试（最多3次）
  - 如仍失败，跳过该图继续处理
  - 在报告中记录失败项
```

### MCP 工具不可用

```markdown
❌ 错误：所需的 MCP 服务未配置

📄 缺失服务：exa, web-search-prime

💡 解决方法：
  1. 检查 ~/.claude/settings.json 配置
  2. 确保已安装并启动 MCP 服务
  3. 运行 /mcp list 查看已加载服务
```

## 注意事项

1. **只处理章节 03-07**：章节 01、02、08、09 不需要附图
2. **不修改正文内容**：只插入附图，不修改章节文字
3. **附图编号全局连续**：确保所有章节的附图编号从1开始连续
4. **备份原始文件**：建议用户在执行前备份章节文件
5. **支持 Mermaid**：生成的附图使用 Mermaid 语法，需使用支持的编辑器查看

## MCP 工具依赖

本命令可能需要以下 MCP 服务：

| MCP 服务 | 用途 |
|---------|------|
| exa | 搜索技术实现参考（可选） |
| web-search-prime | 搜索技术标准（可选） |

**注意**：MCP 工具主要用于生成器内部，本命令主要负责调度。

## 输出格式

最终报告格式：

```markdown
## 附图更新完成

**执行时间**: 2026-01-08 16:30:45
**工作目录**: {directory}

---

### 📊 总体统计

- **扫描章节**: {count}个
- **需要更新**: {count}个章节
- **生成附图**: {count}幅
- **插入成功**: {count}幅

---

### 📝 章节更新详情

| 章节文件 | 附图数量 | 附图编号 | 状态 |
|---------|---------|---------|------|
| 03_背景技术.md | 1 | 图4 | ✅ |
| 05_技术方案.md | 2 | 图5, 图6 | ✅ |
| 07_具体实施方式.md | 3 | 图7, 图8, 图9 | ✅ |

---

### 🎨 生成的附图清单

{附图清单表格}

---

### ✅ 附图编号验证

- **编号范围**: 图1 - 图{max}
- **连续性**: ✅ 连续

---

### 📁 修改的文件

{文件列表}

---

**提示**: 附图已以 Mermaid 代码块形式嵌入到章节文件中。
在支持 Mermaid 的编辑器（如 Typora、VS Code）中可直接预览渲染效果。
```
